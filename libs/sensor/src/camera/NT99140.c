/*******************************************************************************************
 File Name: NT99140.c

 Version: 1.00

 Discription: NT99140 摄像头初始化。

 Author:yulin deng

 Email :flowingfeeze@163.com

 Date:星期五, 四月 19 2013

 Copyright:(c)JIELI  2011  @ , All Rights Reserved.
*******************************************************************************************/
#ifndef NT99140_c
#define  NT99140_c
#include "iic.h"
#include "isp_dev.h"
#include "isp_com.h"


S_IIC_FUN NT99140_iic_fun;

typedef struct
{
    u16 addr;
    u8 value;
}Sensor_reg_ini;

const Sensor_reg_ini NT99141_INI_REG[]=
{
//initial setting
{0x32F0, 0x01},
{0x3109, 0x04},
{0x3040, 0x04},
{0x3041, 0x02},
{0x3042, 0xFF},
{0x3043, 0x08},
{0x3052, 0xE0},
{0x305F, 0x33},
{0x3100, 0x07},
{0x3106, 0x03},

{0x3105, 0x01},
{0x3108, 0x05},
{0x3110, 0x22},
{0x3111, 0x57},
{0x3112, 0x22},
{0x3113, 0x55},
{0x3114, 0x05},
{0x3135, 0x00},

{0x3290, 0x01},
{0x3291, 0x80},
{0x3296, 0x01},
{0x3297, 0x73},

{0x3250, 0x80},
{0x3251, 0x03},
{0x3252, 0xFF},
{0x3253, 0x00},
{0x3254, 0x03},
{0x3255, 0xFF},
{0x3256, 0x00},
{0x3257, 0x50},

{0x3270, 0x00},
{0x3271, 0x0C},
{0x3272, 0x18},
{0x3273, 0x32},
{0x3274, 0x44},
{0x3275, 0x54},
{0x3276, 0x70},
{0x3277, 0x88},
{0x3278, 0x9D},
{0x3279, 0xB0},
{0x327A, 0xCF},
{0x327B, 0xE2},
{0x327C, 0xEF},
{0x327D, 0xF7},
{0x327E, 0xFF},

{0x3302, 0x00},
{0x3303, 0x40},
{0x3304, 0x00},
{0x3305, 0x96},
{0x3306, 0x00},
{0x3307, 0x29},
{0x3308, 0x07},
{0x3309, 0xBA},
{0x330A, 0x06},
{0x330B, 0xF5},
{0x330C, 0x01},
{0x330D, 0x51},
{0x330E, 0x01},
{0x330F, 0x30},
{0x3310, 0x07},
{0x3311, 0x16},
{0x3312, 0x07},
{0x3313, 0xBA},

//{0x3326, 0x02},
//{0x32F6, 0x0F},
//{0x32F9, 0x42},
//{0x32FA, 0x24},
//{0x3325, 0x4A},
//{0x3330, 0x00},
//{0x3331, 0x07},
//{0x3332, 0xE8},
//{0x3338, 0x30},
//{0x3339, 0x84},
//{0x333A, 0x48},
//{0x333F, 0x07},
//
//{0x3360, 0x10},
//{0x3361, 0x18},
//{0x3362, 0x1f},
//{0x3363, 0x37},
//{0x3364, 0x70},
//{0x3365, 0x60},
//{0x3366, 0x4A},
//{0x3367, 0x30},
//{0x3368, 0x30},
//{0x3369, 0x28},
//{0x336A, 0x20},
//{0x336B, 0x14},
{0x3326, 0x02},
{0x32F6, 0x0F},
{0x32F9, 0x42},
{0x32FA, 0x24},
{0x3325, 0x4A},
{0x3330, 0x00},
{0x3331, 0x05},
{0x3332, 0xFF},
{0x3338, 0x30},
{0x3339, 0x84},
{0x333A, 0x48},
{0x333F, 0x07},

{0x3360, 0x10},
{0x3361, 0x18},
{0x3362, 0x1f},
{0x3363, 0x37},
{0x3364, 0x70},
{0x3365, 0x60},
{0x3366, 0x4A},
{0x3367, 0x30},
{0x3368, 0x38},
{0x3369, 0x38},
{0x336A, 0x28},
{0x336B, 0x1F},
{0x336C, 0x00},
{0x336D, 0x20},
{0x336E, 0x1C},
{0x336F, 0x18},
{0x3370, 0x10},
{0x3371, 0x38},
{0x3372, 0x3C},
{0x3373, 0x3F},
{0x3374, 0x3F},
{0x338A, 0x34},
{0x338B, 0x7F},
{0x338C, 0x10},
{0x338D, 0x23},
{0x338E, 0x7F},
{0x338F, 0x14},
{0x3375, 0x0A},
{0x3376, 0x0C},
{0x3377, 0x10},
{0x3378, 0x14},

{0x32B0, 0x55},
{0x32B1, 0x69},
{0x32B2, 0x69},
{0x32B3, 0x55},
{0x3012, 0x02},
{0x3013, 0xD0},
{0x306a, 0x01},
//[YUYV_1280x720_30.00_30.01_Fps]
{0x32BF, 0x60},
{0x32C0, 0x5A},
{0x32C1, 0x5A},
{0x32C2, 0x5A},
{0x32C3, 0x00},
{0x32C4, 0x2a},
{0x32C5, 0x20},
{0x32C6, 0x20},
{0x32C7, 0x00},
{0x32C8, 0xDD},
{0x32C9, 0x5A},
{0x32CA, 0x7A},
{0x32CB, 0x7A},
{0x32CC, 0x7A},
{0x32CD, 0x7A},
{0x32DB, 0x7B},
{0x3200, 0x3E},
{0x3201, 0x0F},
{0x3028, 0x24},
{0x3029, 0x20},
{0x302A, 0x04},
{0x3022, 0x27}, //24
{0x3023, 0x24},
{0x3002, 0x00},
{0x3003, 0x04},
{0x3004, 0x00},
{0x3005, 0x04},
{0x3006, 0x05},
{0x3007, 0x03},
{0x3008, 0x02},
{0x3009, 0xD3},
{0x300A, 0x06},
{0x300B, 0x8B},
{0x300C, 0x02},
{0x300D, 0xE0},
{0x300E, 0x05},
{0x300F, 0x00},
{0x3010, 0x02},
{0x3011, 0xD0},
{0x32B8, 0x3F},
{0x32B9, 0x31},
{0x32BB, 0x87},
{0x32BC, 0x38},
{0x32BD, 0x3C},
{0x32BE, 0x34},
{0x3201, 0x3F},
{0x3021, 0x06},
{0x3060, 0x01},

//{0x3025,0x02},//彩条
};
const Sensor_reg_ini NT99140_INI_REG[]=
{
    //initial setting
{0x32F0,0x01},    // Output_Format_Sel 0:YCbCr
{0x3028,0x05},
{0x3029,0x02},
{0x302a,0x00},
{0x3336,0x14},
{0x3210,0x03},
{0x3211,0x04},
{0x3212,0x05},
{0x3213,0x04},
{0x3214,0x03},
{0x3215,0x04},
{0x3216,0x05},
{0x3217,0x04},
{0x3218,0x03},
{0x3219,0x04},
{0x321A,0x05},
{0x321B,0x04},
{0x321C,0x03},
{0x321D,0x04},
{0x321E,0x05},
{0x321F,0x04},
{0x3220,0x01},
{0x3221,0x37},
{0x3222,0x01},
{0x3223,0x34},
{0x3224,0x01},
{0x3225,0x34},
{0x3226,0x01},
{0x3227,0x31},
{0x3228,0x00},
{0x3229,0xAF},
{0x322A,0x00},
{0x322B,0xAF},
{0x322C,0x00},
{0x322D,0xAF},
{0x322E,0x00},
{0x322F,0xAF},
{0x3230,0x1D},	// Gain Upperbound
{0x3231,0x00},
{0x3232,0x04},	// exposure line upperbound
{0x3233,0x30},
{0x3234,0x42},
{0x3270,0x00},
{0x3271,0x0B},
{0x3272,0x16},
{0x3273,0x2B},
{0x3274,0x3F},
{0x3275,0x51},
{0x3276,0x72},
{0x3277,0x8F},
{0x3278,0xA7},
{0x3279,0xBC},
{0x327A,0xDC},
{0x327B,0xF0},
{0x327C,0xFA},
{0x327D,0xFE},
{0x327E,0xFF},
{0x3302,0x00},
{0x3303,0x3C},
{0x3304,0x00},
{0x3305,0xA6},
{0x3306,0x00},
{0x3307,0x1C},
{0x3308,0x07},
{0x3309,0xE1},
{0x330A,0x06},
{0x330B,0x9B},
{0x330C,0x01},
{0x330D,0x84},
{0x330E,0x00},
{0x330F,0xEF},
{0x3310,0x07},
{0x3311,0x69},
{0x3312,0x07},
{0x3313,0xA9},
{0x32DB,0x90},
{0x3300,0x70},
{0x3301,0x40},
{0x3024,0x00},
{0x3040,0x04},    // Calibration Control
{0x3041,0x02},    // Auto Calibration
{0x3042,0xFF},    // ABLC_Thr_Top
{0x3043,0x14},    // ABLC_Thr_Bottom
{0x3052,0xd0},
{0x3057,0x80},    // DeRowDefect_ThrH
{0x3058,0x00},    // DeRowDefect_ThrL
{0x3059,0x2F},    // DeRowDefect_Control
{0x305f,0x22},	// 44->22
{0x32b0,0x00},
{0x32b1,0x90},
{0x32BB,0x0b},
{0x32bd,0x10},
{0x32be,0x05},
{0x32bf,0x4a},
{0x32c0,0x40},
{0x32C3,0x08},    // AGC_Min_Limit
{0x32c5,0x1f},
{0x32cd,0x01},
{0x32d3,0x00},
{0x32f6,0x0c},	// Special_Effect_1
{0x3324,0x00},
{0x3118,0xF2},
{0x3119,0xF2},
{0x311A,0x13},
{0x3106,0x01},
{0x3108,0x55},
{0x3105,0x41},     // 40uA
{0x3112,0x21},
{0x3113,0x55},
{0x3114,0x05},
{0x3343,0xA0},
{0x333b,0x20},
{0x333c,0x28},
{0x3344,0x28},
{0x3345,0x30},
{0x3346,0x30},
{0x3348,0x00},
{0x3349,0x40},
{0x334a,0x30},
{0x334b,0x00},
{0x334d,0x15},


//[YUYV_1280x720_30.04_Fps]
{0x3200, 0x3E},
{0x3028, 0x24},
{0x3029, 0x20},
{0x302a, 0x04},
{0x3022, 0x27},//0x24
{0x3023, 0x24},
{0x3002, 0x00},
{0x3003, 0x04},
{0x3004, 0x00},
{0x3005, 0x04},
{0x3006, 0x05},
{0x3007, 0x03},
{0x3008, 0x02},
{0x3009, 0xd3},
{0x300a, 0x06},
{0x300b, 0x7c},
{0x300c, 0x02},
{0x300d, 0xe6},
{0x300e, 0x05},
{0x300f, 0x00},           //24
{0x3010, 0x02},
{0x3011, 0xd0},
{0x32b0, 0x00},
{0x32b1, 0x00},
{0x32b2, 0x01},
{0x32b3, 0x7c},
{0x32b4, 0x00},
{0x32b5, 0x64},
{0x32b6, 0x99},
{0x32bb, 0x1b},
{0x32bc, 0x40},
{0x32c1, 0x22},
{0x32c2, 0xe6},
{0x32c8, 0x6f},
{0x32c9, 0x5d},
{0x32c4, 0x00},
{0x3201, 0x3f},
{0x3021, 0x16},
{0x3060, 0x01},


};




#define WRCMD 0x54
#define RDCMD 0x55
static u8 nt99141_iic_sel;

static u8 nt99141_i2c_read(u16 iic_address,u8 *data)
{
    iic_tx(WRCMD);
    delay(10);
    iic_tx(iic_address>>8);
    iic_tx_we(iic_address&0xff);
    delay(10);

    iic_tx(RDCMD);
    delay(10);
    *data = iic_rx_we();
    return *data;
}

static void nt99141_i2c_write(u16 SubAddr, u8 data)
{
	iic_tx(WRCMD);
	delay(10);
	iic_tx(SubAddr>>8);
	iic_tx(SubAddr&0xff);
	delay(10);
	iic_tx_we(data);
	delay(10);
}

unsigned char wrNT99140Reg(u16 regID, unsigned char regDat)
{
    if(nt99141_iic_sel)
    {
        nt99141_i2c_write(regID, regDat);
        return 1;
    }


	NT99140_iic_fun.startSCCB();
	if(0 == NT99140_iic_fun.SCCBwriteByte(WRCMD))
	{
		puts("a");
		NT99140_iic_fun.stopSCCB();
		return(0);
	}
	delay(1000);
  if(0 == NT99140_iic_fun.SCCBwriteByte((u8)(regID>>8)))
	{
		puts("b");
		NT99140_iic_fun.stopSCCB();
		return(0);
	}
	delay(1000);
	if(0 == NT99140_iic_fun.SCCBwriteByte((u8)(regID&0xff)))
	{
		puts("b");
		NT99140_iic_fun.stopSCCB();
		return(0);
	}
	delay(1000);
  	if(0 == NT99140_iic_fun.SCCBwriteByte(regDat))
	{
		puts("c");
		NT99140_iic_fun.stopSCCB();
		return(0);
	}
  	NT99140_iic_fun.stopSCCB();

  	return(1);
}

unsigned char rdNT99140Reg(u16 regID, unsigned char *regDat)
{

    if(nt99141_iic_sel)
    {
        nt99141_i2c_read(regID, regDat);
        return 1;
    }

	//通过写操作设置寄存器地址
	NT99140_iic_fun.startSCCB();
	if(0 == NT99140_iic_fun.SCCBwriteByte(WRCMD))
	{
		puts("1");
		NT99140_iic_fun.stopSCCB();
		return(0);
	}
	delay(1000);
  if(0 == NT99140_iic_fun.SCCBwriteByte((u8)(regID>>8)))
	{
		puts("2");
		NT99140_iic_fun.stopSCCB();
		return(0);
	}
	delay(1000);
  if(0 == NT99140_iic_fun.SCCBwriteByte((u8)(regID&0xff)))
	{
		puts("3");
		NT99140_iic_fun.stopSCCB();
		return(0);
	}
	NT99140_iic_fun.stopSCCB();
	delay(1000);

	//设置寄存器地址后，才是读
	NT99140_iic_fun.startSCCB();
	if(0 == NT99140_iic_fun.SCCBwriteByte(RDCMD))
	{
		puts("4");
		NT99140_iic_fun.stopSCCB();
		return(0);
	}
	delay(1000);
  	*regDat = NT99140_iic_fun.SCCBreadByte();
  	NT99140_iic_fun.noAck();
  	NT99140_iic_fun.stopSCCB();

//  	puts("finish");
  	return(1);
}



/*************************************************************************************************
    sensor api
*************************************************************************************************/
void NT99140_config_SENSOR(u16 *width, u16 *height, u8 *format, u8 *frame_freq)
{
    u32 i;
    u8 pid = 0x00;

    rdNT99140Reg(0x3001, &pid);


    NT99140_set_output_size(width, height, frame_freq);
    if (pid)
    {
        sensor_puts("is NT99141\n");
        for(i=0;i<sizeof(NT99141_INI_REG)/sizeof(Sensor_reg_ini);i++)
        {
            wrNT99140Reg(NT99141_INI_REG[i].addr,NT99141_INI_REG[i].value);
        }
    }
    else
    {
        sensor_puts("is NT99140\n");
        for(i=0;i<sizeof(NT99140_INI_REG)/sizeof(Sensor_reg_ini);i++)
        {
            wrNT99140Reg(NT99140_INI_REG[i].addr,NT99140_INI_REG[i].value);
        }
    }

    if(*frame_freq == 15)
    {

    }


    if(*frame_freq == 30)
    {

    }


  	*format = SEN_IN_FORMAT_YUYV;

//    wrOV9712Reg(0x8d, 0x12); //test mode
    return;
}

void updateNT9914XAE(u8 update)
{
    static u8 orVal = 0;

    if (orVal == 0)
    {
        rdNT99140Reg(0x32bc, &orVal);
    }

    wrNT99140Reg(0x32bc, orVal+update);
}


s32 NT99140_set_output_size(u16 *width, u16 *height, u8 *freq)
{
	*width = 1280;
	*height = 720;

	*freq = 30;

	return 0;
}



s32 NT99140_power_ctl(u8 isp_dev, u8 is_work)
{
	if (is_work)
	{
		if (isp_dev==ISP_DEV_0)
		{
			ISP0_XCLK_IO_ABLE();
		}
		else
		{
			ISP1_XCLK_IO_ABLE();
		}
	}
	else
	{
		if (isp_dev==ISP_DEV_0)
		{
			ISP0_XCLK_IO_DISABLE();
		}
		else
		{
			ISP1_XCLK_IO_DISABLE();
		}
	}

	return 0;
}


void NT99140_xclk_set(u8 isp_dev)
{
//	IOMC1 |= 0X0A<<16;//output PWM 24MHz
    ISP_XCLK_MAPOUT(); //output 24MHz

	if (isp_dev==ISP_DEV_0)
	{
		ISP0_XCLK_IO_ABLE();
	}
	else
	{
		ISP1_XCLK_IO_ABLE();
	}
}



s32 NT99140_ID_check(void)
{
    u8 pid = 0x00;
    u8 ver = 0x00;
    u8 i ;

    rdNT99140Reg(0x3000, &pid);
    puts("NT9914x Sensor PID ");
    put_u8hex(pid);

    puts("\n");

	if (pid != 0x14)
	{
	    puts("---!NT9914x---\n");
		return -1;
	}

    return 0;
}

void NT99140_reset(u8 isp_dev)
{
    puts("reset\n");

    if (isp_dev==ISP_DEV_0)
    {
        SET_RESET_OUT_A();
        SET_RESET_H_A();
        delay(40000);
        SET_RESET_L_A();
        delay(40000);
        SET_RESET_H_A();
        delay(40000);
    }
    else
    {
        SET_RESET_OUT_B();
        SET_RESET_H_B();
        delay(40000);
        SET_RESET_L_B();
        delay(40000);
        SET_RESET_H_B();
        delay(40000);
    }
}

void NT99140_iic_set(u8 isp_dev)
{
	iic_select(&NT99140_iic_fun, isp_dev);
}

s32 NT99140_check(u8 isp_dev)
{
    if(isp_dev == ISP_DEV_0){
        nt99141_iic_sel = 1;
    }else{
        nt99141_iic_sel = 0;
    }

    if(nt99141_iic_sel)
    {
        iic_ini();
    }

	NT99140_xclk_set(isp_dev);
	NT99140_iic_set(isp_dev);
	NT99140_reset(isp_dev);

	if (0 != NT99140_ID_check())
	{
		return -1;
	}

	return 0;
}


s32 NT99140_init(u8 isp_dev, u16 *width, u16 *height, u8 *format, u8 *frame_freq)
{
	puts("\n\n NT99140_init \n\n");

	if (0 != NT99140_check(isp_dev))
	{
		return -1;
	}

	NT99140_config_SENSOR(width, height, format, frame_freq);

	return 0;
}

void NT99140_W_Reg(u16 addr, u16 val)
{
    printf_without_mutex("update reg%x with %x\n",addr,val);
    wrNT99140Reg(addr,(u8)val);
}
u16 NT99140_R_Reg(u16 addr)
{
    u8 val;
    rdNT99140Reg(addr,&val);
    return val;
}
#endif

